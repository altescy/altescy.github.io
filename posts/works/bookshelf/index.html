<!doctype html><html><head><title>電子書籍をオンライン管理する</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta http-equiv=x-ua-compatible content="ie=edge"><link rel=stylesheet href=/assets/css/bootstrap.min.css><link rel=stylesheet href=/assets/css/layouts/main.css><link rel=stylesheet href=/assets/css/style.css><link rel=stylesheet href=/assets/css/navigators/navbar.css><link href="https://fonts.googleapis.com/css2?family=Muli:wght@300;400;500;600" rel=stylesheet><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.11.2/css/all.min.css><link rel=icon type=image/png href=/images/logo_trans.png><link rel=stylesheet href=/assets/css/style.css><meta property="og:site_name" content="altescy"><meta property="og:title" content="電子書籍をオンライン管理する"><meta property="og:type" content="article"><meta property="og:url" content="/posts/works/bookshelf/"><meta property="og:type" content="article"><meta name=twitter:card content="summary_large_image"><meta name=og:image content="/images/posts/works/bookshelf/hero.jpg"><meta name=og:image:url content="/images/posts/works/bookshelf/hero.jpg"><meta property="og:description" content="Portfolio and personal blog of altescy."><meta property="twitter:description" content="Portfolio and personal blog of altescy."><meta name=description content="電子書籍をオンライン管理する"><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/styles/atom-one-dark.min.css><link rel=stylesheet href=/assets/css/layouts/single.css><link rel=stylesheet href=/assets/css/navigators/sidebar.css></head><body data-spy=scroll data-target=#TableOfContents data-offset=80><div class="container-fluid bg-dimmed wrapper"><nav class="navbar navbar-expand-xl top-navbar final-navbar shadow"><div class=container><button class="navbar-toggler navbar-light" id=sidebar-toggler type=button onclick=toggleSidebar()>
<span class=navbar-toggler-icon></span></button>
<a class=navbar-brand href=/><img src=/images/logo_trans.png>altescy</a>
<button class="navbar-toggler navbar-light" id=toc-toggler type=button onclick=toggleTOC()>
<span class=navbar-toggler-icon></span></button><div class="collapse navbar-collapse" id=top-nav-items><ul class="navbar-nav ml-auto"></ul></div></div><img src=/images/logo_trans.png class=d-none id=main-logo>
<img src=/images/logo_trans.png class=d-none id=inverted-logo></nav><section class=sidebar-section id=sidebar-section><div class=sidebar-holder><div class=sidebar id=sidebar><input type=text placeholder=Search data-search id=search-box><div class=sidebar-tree><ul class=tree id=tree><li id=list-heading><a href=/posts data-filter=all>Posts</a></li><div class=subtree><li><a href=/posts/hello/>Hello, World!</a></li><li><a href=/posts/diary/>Diary</a></li><li><i class="fas fa-minus-circle"></i><a class=active href=/posts/works/>Works</a><ul class=active><li><a class=active href=/posts/works/bookshelf/>電子書籍をオンライン管理する</a></li></ul></li></div></ul></div></div></div></section><section class=content-section id=content-section><div class=content><div class="container p-0 read-area"><div class="hero-area col-sm-12" id=hero-area style=background-image:url(/images/posts/works/bookshelf/hero.jpg)></div><div class=page-content><div class="author-profile ml-auto align-self-lg-center"><img class=rounded-circle src=/images/logo.png><h5 class=author-name>Yasuhiro Yamaguchi</h5><p>September 26, 2020</p></div><div class=title><h1>電子書籍をオンライン管理する</h1></div><div class=post-content id=post-content><h2 id=はじめに>はじめに</h2><p>最近，書籍を電子版で購入することが増えたことで電子書籍の管理が煩雑になってきました．
多くの場合，電子書籍を購入すると販売サイトから書籍データをダウンロードできて，
それらを自分の端末に入れて読むことになります．また，一つの書籍に対してPDFやEPUB
など複数のフォーマットが用意されていることも多いです．本を購入するたびに増えていく
ファイルを効率よく管理するために，先日<a href=https://github.com/altescy/bookshelf>Bookshelf</a>
という電子書籍管理のためのWEBアプリをつくりました．</p><p><a href=https://github.com/altescy/bookshelf><img src=https://github-link-card.s3.ap-northeast-1.amazonaws.com/altescy/bookshelf.png width=460px></a></p><p>これまでは電子書籍の管理のためにDropboxやGoogle Driveなどのクラウドストレージに
ファイルを突っ込んでいたのですが，ファイルへのアクセスが面倒であったり，
ストレージの容量を気にする必要があったりと不満を感じていました．
<a href=https://github.com/altescy/bookshelf>Bookshelf</a>にはこうした問題を解決するための
機能を実装しました．</p><h2 id=bookshelf>Bookshelf</h2><p><a href=https://github.com/altescy/bookshelf>Bookshelf</a>は電子書籍を管理するための
WEBアプリであり，フロントエンドはVue.js + TypeScript, バックエンドはGo言語で
実装されています．主な特徴は以下のとおりです:</p><ul><li><a href=#%E6%9B%B8%E7%B1%8D%E6%83%85%E5%A0%B1%E3%81%AE%E7%99%BB%E9%8C%B2>書籍情報の登録</a></li><li><a href=#opds%E3%83%95%E3%82%A3%E3%83%BC%E3%83%89%E3%81%AE%E9%85%8D%E4%BF%A1>OPDSフィードの配信</a></li><li><a href=#%E8%A4%87%E6%95%B0%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%83%E3%83%88%E3%81%AE%E7%99%BB%E9%8C%B2>複数フォーマットの登録</a></li><li><a href=#s3%E4%BA%92%E6%8F%9B%E3%82%B9%E3%83%88%E3%83%AC%E3%83%BC%E3%82%B8%E3%81%B8%E3%81%AE%E4%BF%9D%E5%AD%98>S3互換ストレージへの保存</a></li><li><a href=#%E3%82%B7%E3%83%B3%E3%82%B0%E3%83%AB%E3%83%90%E3%82%A4%E3%83%8A%E3%83%AA>シングルバイナリ</a></li></ul><p>書籍のメタ情報はPostgresかSQLite3に，書籍ファイルはローカルのファイルシステムか
S3互換のオブジェクトストレージに保存することができます．また，本やファイルの
追加や削除はすべてブラウザから行えます．</p><h3 id=書籍情報の登録>書籍情報の登録</h3><p><a href=https://github.com/altescy/bookshelf>Bookshelf</a>では書籍データを保存する際に
著者や出版社，表紙などの書籍情報を合わせて登録します．書籍情報を登録する際は
ISBNを入力すると自動的に他のフィールドを補完するため，効率よく書籍を登録する
ことができます．登録された書籍情報は書籍へのアクセスの利便性を上げるだけでなく，
後述するOPDSフィードの配信にも使われます．</p><p><img src=/images/posts/works/bookshelf/bookshelf.png alt=Bookshelf></p><p>ISBNによる補完には<a href=https://openbd.jp/>openBD</a>という検索APIを利用しています．
主要な書籍の情報はだいたい揃っていて，APIの仕様も簡潔なため非常に使いやすいです．</p><h3 id=opdsフィードの配信>OPDSフィードの配信</h3><p>電子書籍を配信するための規格として<a href=https://opds.io/>OPDS</a>というのがあるようです．
あまり流行ってはいなさそうですが，日本では<a href=https://www.oreilly.co.jp/community/blog/2012/02/opds-catalog-available.html>オライリー・ジャパン</a>や
<a href=https://www.aozora.gr.jp/>青空文庫</a>などでOPDSによるカタログの配信が行われて
います．Bookshelfは登録した書籍をOPDSフォーマットで配信することができます．
OPDSフィードへのリンクはヘッダー右側のアイコンから取得できます．</p><p><img src=/images/posts/works/bookshelf/bookshelf_header.png alt="Bookshelf header"></p><p>OPDSに対応したリーダーであれば，このアプリに登録した書籍をPCやスマートフォン
から読むことができます．例えば<a href=https://johnfactotum.github.io/foliate/>Foliate</a>
というソフトウェアを使うと以下のように書籍の一覧を眺めたりファイルを
ダウンロードしたりできます．このOPDS配信機能とOPDS対応リーダーのおかげで本への
アクセスやローカルでの管理がかなり便利になりました．</p><p><img src=/images/posts/works/bookshelf/foliate_list.png alt="Foliate screenshot"></p><h3 id=複数フォーマットの登録>複数フォーマットの登録</h3><p>Bookshelfでは一つの書籍についてPDFやEPUBなど複数のフォーマットのファイルを
登録できます．ブラウザからは以下のように登録したファイルがアイコンとして表示
され，クリックするとファイルをダウンロードすることができます．</p><p><img src=/images/posts/works/bookshelf/bookshelf_item.png alt="Bookshelf item"></p><p>またOPDSでも複数のフォーマットを配信しているため，例えばFoliateからは以下の
ようにプルダウンメニューからフォーマットを選択してダウンロードすることができます．</p><p><img src=/images/posts/works/bookshelf/foliate_download.png alt="Foliate screenshot"></p><h3 id=s3互換ストレージへの保存>S3互換ストレージへの保存</h3><p>書籍ファイルの保存先をS3互換のオブジェクトストレージに設定することができます．
S3互換のストレージには本家のAWS S3やオープンソースの<a href=https://min.io/>MinIO</a>
などがありますが，私は<a href=https://wasabi.com/>wasabi</a>を使っています．wasabiは
AWS S3に比べて非常にコスパがよく，API呼び出しや転送に対して課金されないため重宝
しています．(1TB未満なら$6/mo程度です．) これで容量をほとんど気にすることなく
電子書籍を管理できます！</p><h3 id=シングルバイナリ>シングルバイナリ</h3><p>Bookshelfはシングルバイナリで動作するアプリケーションです．今回，フロントエンド
をバイナリファイルに含めるために<a href=https://github.com/elazarl/go-bindata-assetfs>go-bindata-assetfs</a>
を使ってみました．これを使うと任意のファイルをGoのコード中にバイナリとして埋め込む
ことができます．
埋め込んだファイルは以下のように<code>http.FileServer</code>に渡して配信しています．</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go>	<span style=color:#a6e22e>router</span>.<span style=color:#a6e22e>NotFound</span> = <span style=color:#a6e22e>http</span>.<span style=color:#a6e22e>FileServer</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>assetfs</span>.<span style=color:#a6e22e>AssetFS</span>{
		<span style=color:#a6e22e>Asset</span>:     <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>Asset</span>,
		<span style=color:#a6e22e>AssetDir</span>:  <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>AssetDir</span>,
		<span style=color:#a6e22e>AssetInfo</span>: <span style=color:#a6e22e>browser</span>.<span style=color:#a6e22e>AssetInfo</span>,
		<span style=color:#a6e22e>Prefix</span>:    <span style=color:#e6db74>&#34;/dist&#34;</span>,
		<span style=color:#a6e22e>Fallback</span>:  <span style=color:#e6db74>&#34;index.html&#34;</span>,
	})
</code></pre></div><h2 id=利用方法>利用方法</h2><p><code>go get</code>してローカル環境で実行するか，Dockerイメージを用意してWEBアプリを
起動できます．</p><h3 id=go-get>go get</h3><p>以下はローカル環境で動かす例です．この例では現在いるディレクトリに
SQLite3のデータベースファイル<code>bookshelf.db</code>と書籍ファイルが保存されるディレクトリ
<code>files/</code>が作成されます．</p><pre><code>$ go get github.com/altescy/bookshelf
$ export BOOKSHELF_DB_URL=sqlite3:///`pwd`/bookshelf.db
$ export BOOKSHELF_STORAGE_URL=file:///`pwd`/files
$ bookshelf
</code></pre><h3 id=docker>Docker</h3><p>Dockerイメージをpullして実行します．以下は上記の例と同じようにSQLite3とローカル
ストレージを利用します．</p><pre><code>$ docker pull altescy/bookshelf:1.2.0
$ docker run -d \
    -v `pwd`:/data \
    -p 8080:8080 \
    -e BOOKSHELF_DB_URL=sqlite3:///data/bookshelf.db \
    -e BOOKSHELF_STORAGE_URL=file:///data/files \
    altescy/bookshelf:1.2.0
</code></pre><h3 id=docker-compose>docker-compose</h3><p>以下はdocker-composeを用いた例で，データベースにPostgres，ストレージにMinIO
を利用しています．ストレージに他のAWS互換ストレージを利用する場合は
<code>BOOKSHELF_STORAGE_URL</code>と<code>BOOKSHELF_AWS_*</code>の値を適当なものに置き換えてください．</p><pre><code>$ git clone https://github.com/altescy/bookshelf.git
$ cd bookshelf
$ cat &lt;&lt; EOF &gt; .env
BOOKSHELF_PORT=80
BOOKSHELF_DB_URL=postgres://user:password@postgres:5432/bookshelf?sslmode=disable
BOOKSHELF_STORAGE_URL=s3://books
BOOKSHELF_CREATE_NEW_STORAGE=1
BOOKSHELF_AWS_ACCESS_KEY_ID=minio_access
BOOKSHELF_AWS_SECRET_ACCESS_KEY=minio_secret
BOOKSHELF_AWS_S3_REGION=us-east-1
BOOKSHELF_AWS_S3_ENDPOINT_URL=http://minio

MINIO_ACCESS_KEY=minio_access
MINIO_SECRET_KEY=minio_secret
MINIO_HOST=0.0.0.0
MINIO_PORT=9000

POSTGRES_USER=user
POSTGRES_PASSWORD=password
POSTGRES_PORT=5432

TZ=Asia/Tokyo
EOF
$ docker-compose up -d
</code></pre><blockquote><p>⚠️ 実際に公開して利用する際は，著作権で保護されたコンテンツをオープンに
してしまわないためにBasic認証などを適切に設定してください．Basic認証を設定した場合，
OPDSのURLは <code>https://user:password@example.com/opds</code> のように設定して利用します．</p></blockquote><h2 id=おわりに>おわりに</h2><p>電子書籍をオンラインで管理するために作ったBookshelfというWEBアプリを紹介
しました．機能は最小限という感じですが，この1ヶ月ほど自分で使ってみて
書籍ファイルの管理がだいぶ楽になったな，という印象です．一方，検索まわりの
機能などは全然手を付けていないのでいろいろと改善できるところはありそうです．
ただ，このアプリをあまり高機能なものにしようとは考えていないので，これからも
ミニマルな仕様を保ちつつちょこちょこと改良していければと思います．</p></div><div class=btn-improve-page><a href=https://github.com/altescy/altescy.github.io/edit/master/content/posts/works/bookshelf.md><i class="fas fa-code-branch"></i>Improve This Page</a></div><hr><div class="row next-prev-navigator"><div class="col-md-12 next-article"><a href=/posts/hello/ class="btn btn-outline-info"><span>Next <i class="fas fa-chevron-circle-right"></i></span><br><span>Hello, world!</span></a></div></div><hr><div id=disqus_thread></div><script type=text/javascript>(function(){if(window.location.hostname=="localhost")return;var dsq=document.createElement("script");dsq.type="text/javascript";dsq.async=true;var disqus_shortname="altescy";dsq.src="//"+disqus_shortname+".disqus.com/embed.js";(document.getElementsByTagName("head")[0]||document.getElementsByTagName("body")[0]).appendChild(dsq);})();</script><noscript>Please enable JavaScript to view the
<a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com/ class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div></div></div></section><section class=toc-section id=toc-section><div class=toc-holder><h5 class="text-center pl-3">Table of Contents</h5><hr><div class=toc><nav id=TableOfContents><ul><li><a href=#はじめに>はじめに</a></li><li><a href=#bookshelf>Bookshelf</a><ul><li><a href=#書籍情報の登録>書籍情報の登録</a></li><li><a href=#opdsフィードの配信>OPDSフィードの配信</a></li><li><a href=#複数フォーマットの登録>複数フォーマットの登録</a></li><li><a href=#s3互換ストレージへの保存>S3互換ストレージへの保存</a></li><li><a href=#シングルバイナリ>シングルバイナリ</a></li></ul></li><li><a href=#利用方法>利用方法</a><ul><li><a href=#go-get>go get</a></li><li><a href=#docker>Docker</a></li><li><a href=#docker-compose>docker-compose</a></li></ul></li><li><a href=#おわりに>おわりに</a></li></ul></nav></div></div></section></div><footer class="container-fluid text-center align-content-center footer pb-2"><div class="container pt-5"><div class="row text-left"><div class="col-md-4 col-sm-12"><h5>Navigation</h5><ul><li class=nav-item><a class=smooth-scroll href=/#about>About</a></li><li class=nav-item><a class=smooth-scroll href=/#experiences>Experiences</a></li><li class=nav-item><a class=smooth-scroll href=/#projects>Projects</a></li><li class=nav-item><a class=smooth-scroll href=/#recent-posts>Recent Posts</a></li><li class=nav-item><a class=smooth-scroll href=/#achievements>Achievements</a></li></ul></div><div class="col-md-4 col-sm-12"><h5>Contact Me</h5><ul><li><span>Email:</span> <span>altescy@fastmail.com</span></li></ul></div></div></div><hr><div class=container><div class="row text-left"><div class=col-md-4><a id=theme href=https://github.com/hossainemruz/toha target=#><img src=/assets/images/inverted-logo.png>
Toha</a></div><div class="col-md-4 text-center">© 2020 Copyright.</div><div class="col-md-4 text-right"><a id=hugo href=https://gohugo.io/>Powered by Hugo
<img src=/assets/images/hugo-logo-wide.svg alt="Hugo Logo" height=18></a></div></div></div></footer><script src=/assets/js/jquery-3.4.1.min.js></script><script src=/assets/js/bootstrap.min.js></script><script src=/assets/js/navbar.js></script><script src=/assets/js/main.js></script><script src=https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.18.1/highlight.min.js></script><script src=/assets/js/single.js></script><script>hljs.initHighlightingOnLoad();</script></body></html>